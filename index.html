<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>氧气贷申请</title> <link rel="stylesheet" href="style.css"> <style>
        /* 保持你原有的 style.css 样式 */
        /* 新增样式用于过期或无效提示 */
        #expired-overlay, #loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(255, 255, 255, 0.95); /* 半透明白色背景 */
            display: flex;
            justify-content: center;
            align-items: center;
            flex-direction: column; /* 保持垂直居中 */
            z-index: 1000; /* 确保在最顶层 */
            text-align: center;
        }
        #expired-overlay h2, #expired-overlay p {
            color: #333;
            font-size: 28px;
            margin-bottom: 20px;
        }
        #expired-overlay p {
            font-size: 18px;
        }
        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-left-color: #007bff; /* 转圈的颜色 */
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        /* 隐藏加载文本 */
        #loading-overlay h2, #loading-overlay p {
            display: none; 
        }
    </style>
</head>
<body>
    <div id="loading-overlay">
        <div class="spinner"></div>
        </div>

    <div id="expired-overlay" style="display: none;">
        <h2>此链接已失效或已过期</h2>
        <p>抱歉，您访问的内容已无法使用。</p>
        <p>请联系相关人员获取最新链接或帮助。</p>
    </div>

    <div class="container" id="main-content" style="display: none;"> 
        <div class="header-logo">
            <svg viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg">
                <path d="M12 1L3 5v6c0 5.55 3.84 10.74 9 12 5.16-1.26 9-6.45 9-12V5l-9-4zm0 10.99h7c-.53 4.12-3.28 7.79-7 8.94V12H5V6.3l7-3.11v8.8z"/>
            </svg>
        </div>
        <h2 id="app-title">氧气贷申请</h2>
        <p>请填写真实信息以完成身份验证</p>
        <form id="info-form">
            <input type="text" id="name" placeholder="姓名 (必填)" required>
            <input type="text" id="id-card" placeholder="身份证号 (必填)" required pattern="\d{17}[\dxX]">
            <input type="tel" id="phone" placeholder="手机号码 (必填)" required>
            <div class="upload-area">
                <input type="file" id="id-front-upload" required accept="image/*">
                <label for="id-front-upload" class="upload-label">点击上传身份证人像面</label>
                <div class="preview-container">
                    <img class="preview-image" src="#" alt="预览">
                    <div class="overlay">
                        <div class="progress-circle"></div>
                        <div class="checkmark"></div>
                    </div>
                </div>
            </div>
            <div class="upload-area">
                <input type="file" id="id-back-upload" required accept="image/*">
                <label for="id-back-upload" class="upload-label">点击上传身份证国徽面</label>
                <div class="preview-container">
                    <img class="preview-image" src="#" alt="预览">
                    <div class="overlay">
                        <div class="progress-circle"></div>
                        <div class="checkmark"></div>
                    </div>
                </div>
            </div>
            <button type="submit">下一步</button>
        </form>
    </div>

    <script>
        // === 原始的文件上传处理脚本 ===
        function handleFileUpload(fileInput, previewContainer, label) {
            if (!fileInput.files || fileInput.files.length === 0) { return; }
            const file = fileInput.files[0];
            const reader = new FileReader();
            reader.onload = function(e) {
                const previewImage = previewContainer.querySelector('.preview-image');
                previewImage.src = e.target.result;
                previewContainer.style.display = 'block';
                label.style.display = 'none';
                previewContainer.classList.remove('uploaded');
                previewContainer.classList.add('uploading');
                const uploadTime = Math.random() * (12000 - 8000) + 8000; // 模拟上传时间
                setTimeout(() => {
                    previewContainer.classList.remove('uploading');
                    previewContainer.classList.add('uploaded');
                }, uploadTime);
            }
            reader.readAsDataURL(file);
        }
        const frontInput = document.getElementById('id-front-upload');
        const backInput = document.getElementById('id-back-upload');
        const frontPreview = frontInput.nextElementSibling.nextElementSibling;
        const frontLabel = frontInput.nextElementSibling;
        const backPreview = backInput.nextElementSibling.nextElementSibling;
        const backLabel = backInput.nextElementSibling;
        frontInput.addEventListener('change', () => handleFileUpload(frontInput, frontPreview, frontLabel));
        backInput.addEventListener('change', () => handleFileUpload(backInput, backPreview, backLabel));

        // === 原始的表单提交和URL参数处理脚本 ===
        document.getElementById('info-form').addEventListener('submit', function(event) {
            event.preventDefault();
            let nextPageUrl = 'face-recognition.html'; // 你的下一步页面
            let searchParams = new URLSearchParams();

            // 原始逻辑：解析URL hash (#) 中的参数
            if (window.location.hash && window.location.hash.length > 1) {
                try {
                    const encodedData = window.location.hash.substring(1);
                    const decodedString = decodeURIComponent(escape(window.atob(encodedData)));
                    const params = JSON.parse(decodedString);

                    if (params.amount && params.reason) {
                        const reasonBase64 = window.btoa(unescape(encodeURIComponent(params.reason)));

                        searchParams.set('amount', params.amount);
                        searchParams.set('reason_b64', reasonBase64); 
                    }
                } catch (e) {
                    console.error("解码URL hash参数失败:", e);
                }
            }

            if (document.getElementById('id-front-upload').files.length > 0 && document.getElementById('id-back-upload').files.length > 0) {
                // 【重要】将当前页面的qr_id参数也带到nextPageUrl
                const currentQrId = new URLSearchParams(window.location.search).get('qr_id');
                if (currentQrId) {
                    searchParams.set('qr_id', currentQrId);
                }

                const queryString = searchParams.toString();
                if (queryString) {
                    window.location.href = nextPageUrl + '?' + queryString;
                } else {
                    window.location.href = nextPageUrl;
                }
            } else {
                alert('请上传所有必需的证件照片。');
            }
        });

        // === 新增的二维码状态检查逻辑 ===
        const mainContentDiv = document.getElementById('main-content');
        const loadingOverlay = document.getElementById('loading-overlay');
        const expiredOverlay = document.getElementById('expired-overlay');

        // 获取 URL 查询参数中的 qr_id
        function getQueryParam(param) {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get(param);
        }

        const qrId = getQueryParam('qr_id'); // 从URL中获取qr_id参数

        // 页面加载时立即执行检查
        window.addEventListener('load', function() {
            if (qrId) { // 只有当qr_id存在时才进行状态检查
                loadingOverlay.style.display = 'flex'; // 显示加载中

                async function checkQrStatus() {
                    try {
                        // 请替换为你的服务器端 check_qr_status.php 的实际地址
                        const response = await fetch(`https://chendai.fun/check_qr_status.php?id=${qrId}`); 
                        const data = await response.json();

                        if (data.status === 'valid') {
                            // 二维码有效，显示主要内容
                            mainContentDiv.style.display = 'block';
                            loadingOverlay.style.display = 'none'; // 隐藏加载中
                            expiredOverlay.style.display = 'none'; // 隐藏过期信息
                        } else {
                            // 二维码无效、过期或被禁用，显示过期消息
                            mainContentDiv.style.display = 'none';
                            loadingOverlay.style.display = 'none'; // 隐藏加载中
                            expiredOverlay.style.display = 'flex'; // 显示过期信息
                        }
                    } catch (error) {
                        console.error('Error checking QR status:', error);
                        // 网络请求失败，显示错误或默认显示过期信息
                        mainContentDiv.style.display = 'none';
                        loadingOverlay.style.display = 'none'; // 隐藏加载中
                        expiredOverlay.style.display = 'flex'; // 显示过期信息
                    }
                }
                checkQrStatus(); // 页面加载时立即检查状态
            } else {
                // 如果没有qr_id参数，默认显示主要内容 (假设没有qr_id也可以正常访问)
                // 如果页面必须通过二维码访问，则可改为显示过期信息
                mainContentDiv.style.display = 'block';
                loadingOverlay.style.display = 'none';
                expiredOverlay.style.display = 'none';
            }
        });
    </script>
</body>
</html>
