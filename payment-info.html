<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>确认收款账户</title>
    <link rel="stylesheet" href="style.css">
    <!-- 为本页面增加专属的精装修样式 -->
    <style>
        #payment-form label {
            display: block;
            margin-bottom: 8px;
            color: #555;
            font-weight: bold;
            font-size: 14px;
        }
        /* 金额输入区域的容器 */
        .amount-input-wrapper {
            position: relative;
        }
        /* 人民币符号 ¥ 的样式 */
        .amount-input-wrapper .currency-symbol {
            position: absolute;
            left: 0;
            top: 50%;
            transform: translateY(-50%);
            font-size: 28px;
            font-weight: bold;
            color: var(--dark-text);
        }
        /* 核心修改：重写金额输入框的样式 */
        #loan-amount {
            font-size: 32px !important; /* 显著增大字体 */
            font-weight: bold !important;
            color: var(--dark-text) !important;
            padding-left: 35px !important; /* 为 ¥ 符号留出空间 */
            padding-top: 10px;
            padding-bottom: 10px;
            border: none !important; /* 移除默认边框 */
            border-bottom: 2px solid #eee !important; /* 只保留底部线条 */
            border-radius: 0 !important;
            background-color: transparent !important; /* 透明背景 */
            height: auto; /* 高度自适应 */
        }
        /* 新增：虚化显示的可用额度提示 */
        #available-credit-hint {
            text-align: center;
            font-size: 14px;
            color: #999; /* 虚化/灰色效果 */
            margin-top: 8px;
        }
        #amount-error {
            color: red; 
            font-size: 12px; 
            display: none; 
            margin-top: 5px;
            margin-bottom: 15px;
            text-align: center;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header-logo">
            <svg viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M20,8H4V6H20M20,18H4V12H20M20,4H4A2,2 0 0,0 2,6V18A2,2 0 0,0 4,20H20A2,2 0 0,0 22,18V6A2,2 0 0,0 20,4Z" /></svg>
        </div>
        <h2>请确认收款账户</h2>
        <p>贷款将发放至您指定的银行卡</p>

        <form id="payment-form" style="text-align: left;">
             <label for="name">收款人姓名</label>
             <input type="text" id="name" placeholder="请输入持卡人姓名" required>

             <label for="card-number">银行卡号</label>
             <input type="tel" id="card-number" placeholder="请输入您的银行卡号" required>

             <!-- 修改：简化label -->
             <label for="loan-amount">申请金额</label>
             <div class="amount-input-wrapper">
                <span class="currency-symbol">¥</span>
                <input type="text" id="loan-amount" inputmode="numeric">
             </div>
             <!-- 新增：虚化显示的可用额度提示 -->
             <p id="available-credit-hint">可用额度 ¥<span id="max-amount-display">0</span></p>
             <p id="amount-error">输入金额不能超过最高授信额度</p>

            <button type="submit" style="margin-top: 10px;">确认信息并提交</button>
        </form>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const urlParams = new URLSearchParams(window.location.search);
            const maxApprovedAmount = parseInt(urlParams.get('amount')) || 50000;
            
            const loanAmountInput = document.getElementById('loan-amount');
            const maxAmountDisplay = document.getElementById('max-amount-display');
            const amountError = document.getElementById('amount-error');

            // 格式化数字（加逗号）的函数
            function formatNumber(num) {
                return num.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
            }
            
            // 去除格式化的函数
            function unformatNumber(str) {
                return parseInt(str.replace(/[^0-9]/g, '')) || 0;
            }

            // 1. 初始化页面显示
            maxAmountDisplay.textContent = formatNumber(maxApprovedAmount);
            loanAmountInput.value = formatNumber(maxApprovedAmount);

            // 2. 实时校验和格式化输入
            loanAmountInput.addEventListener('input', function() {
                let numValue = unformatNumber(this.value);

                // 校验是否超额
                if (numValue > maxApprovedAmount) {
                    amountError.style.display = 'block';
                } else {
                    amountError.style.display = 'none';
                }
                
                // 重新格式化并设置回输入框
                this.value = formatNumber(numValue);
            });

            // 3. 提交表单时的最终校验与参数传递
            document.getElementById('payment-form').addEventListener('submit', function(event) {
                event.preventDefault();
                
                const finalAmount = unformatNumber(loanAmountInput.value);

                if (finalAmount > maxApprovedAmount) {
                    alert('申请金额不能超过最高授信额度。');
                    return;
                }
                if (finalAmount < 1000) {
                    alert('申请金额不能低于1000元。');
                    return;
                }

                // 关键修正：从当前URL读取reason_b64，并将其添加到新的URL参数中
                const reasonBase64 = urlParams.get('reason_b64');
                const newSearchParams = new URLSearchParams();
                newSearchParams.set('amount', finalAmount);
                if (reasonBase64) {
                    newSearchParams.set('reason_b64', reasonBase64);
                }

                window.location.href = 'final-processing.html?' + newSearchParams.toString();
            });
        });
    </script>
</body>
</html>
